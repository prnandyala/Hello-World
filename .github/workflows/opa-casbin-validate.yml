name: Validate Casbin policies with OPA

on:
  pull_request:
  push:
    branches: ["test"]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          find . -maxdepth 5 -type f -print

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Run conversion from inside demo so short relative paths work:
      - name: Convert Casbin policy to JSON
        working-directory: demo
        run: |
          echo "Working dir: $(pwd)"
          # Defensive check for both script and policy file
          if [ ! -f scripts/casbin_to_json.py ]; then
            echo "ERROR: demo/scripts/casbin_to_json.py not found."
            find . -maxdepth 3 -type f -print
            exit 2
          fi

          if [ ! -f scripts/policy.csv ]; then
            echo "ERROR: demo/scripts/policy.csv not found."
            find . -maxdepth 3 -type f -print
            exit 2
          fi

          # ensure output dir exists
          mkdir -p build

          # run the converter (policy path is relative to demo)
          python scripts/casbin_to_json.py \
            --policy-file scripts/policy.csv \
            --out build/casbin_policy.json

          echo "Created: demo/build/casbin_policy.json"
          ls -la build || true

      - name: OPA evaluate
        working-directory: demo
        run: |
          echo "Using OPA version: $(opa version || true)"
          echo "Evaluating demo/build/casbin_policy.json with demo/policy.rego"

          # Print pretty output (useful logs). Don't fail immediately so we can parse count below.
          opa eval --format=pretty --data scripts/policy.rego --input build/casbin_policy.json "data.casbin.deny" || true

          # Robust counting logic
          count=$(opa eval --format=raw --data scripts/policy.rego --input build/casbin_policy.json 'count(data.casbin.deny)' 2>/dev/null || echo "ERR")
          if [ "$count" = "ERR" ]; then
            echo "ERROR: opa eval failed when counting denies. See logs above."
            exit 1
          fi

          echo "deny count: $count"
          if [ "$count" -ne 0 ]; then
            echo "Policy validation failed â€” deny messages:"
            opa eval --format=pretty --data scripts/policy.rego --input build/casbin_policy.json "data.casbin.deny"
            exit 1
          fi

          echo "No denies found. OPA check passed."

      - name: Verify JSON exists
        run: |
          ls - la demo/build || true
          cat demo/build/casbin_policy.json || true

      - name: Upload Casbin JSON artifact
        if: always()   # ðŸ‘ˆ VERY IMPORTANT (uploads even if OPA fails)
        uses: actions/upload-artifact@v4
        with:
          name: casbin-policy-json
          path: demo/build/casbin_policy.json
