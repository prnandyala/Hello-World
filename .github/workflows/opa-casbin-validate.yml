name: Validate Casbin policies with OPA

on:
  pull_request:
  push:
    branches: ["test"]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Optional debug step to confirm files & layout (remove after you confirm it works)
      - name: Debug repo structure
        run: |
          echo "Workspace: demo"
          pwd
          ls -la
          echo "Looking for scripts and casbin files..."
          ls -la scripts || true
          ls -la casbin || true

      # 1) Convert Casbin -> JSON (input for OPA)
      - name: Convert Casbin policy to JSON
        working-directory: demo
        run: |
          # ensure output dir exists (casbin_to_json.py also creates dirs, but this is safe)
          mkdir -p build
          python scripts/casbin_to_json.py \
            --policy-file casbin/policy.csv \
            --out build/casbin_policy.json

      # 2) Evaluate with OPA; fail if any deny messages returned
      - name: OPA evaluate
        working-directory: demo
        run: |
          echo "Evaluating OPA policy against build/casbin_policy.json..."
          echo "OPA version: $(opa version || true)"

          # Show the pretty evaluation (useful for logs)
          opa eval \
            --format=pretty \
            --data opa/policy.rego \
            --input build/casbin_policy.json \
            "data.casbin.deny" || true

          # Robust numeric count check. If count > 0, print denies and exit 1.
          count=$(opa eval --format=raw --data opa/policy.rego --input build/casbin_policy.json 'count(data.casbin.deny)' 2>/dev/null || echo "ERR")
          if [ "$count" = "ERR" ]; then
            echo "ERROR: opa eval failed when counting denies. See logs above."
            exit 1
          fi

          echo "deny count: $count"
          if [ "$count" -ne 0 ]; then
            echo "Policy validation failed â€” printing deny messages:"
            opa eval --format=pretty --data opa/policy.rego --input build/casbin_policy.json "data.casbin.deny"
            exit 1
          fi

          echo "No denies found. OPA check passed."
